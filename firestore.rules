rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Characters: users can only access their own characters
    match /characters/{characterId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.ownerId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.ownerId;
    }
    
    // Groups/Parties: users can read groups they're members of or own
    match /parties/{partyId} {
      // Allow reading if user is owner or member
      allow read: if request.auth != null && 
        (resource.data.ownerId == request.auth.uid || 
         request.auth.uid in resource.data.memberIds);
      
      // Allow listing all parties for authenticated users (for search functionality)
      // Note: Individual read permissions still apply
      allow list: if request.auth != null;
      
      // Allow creating for any authenticated user
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.ownerId;
      
      // Allow update/delete for owner only
      allow update, delete: if request.auth != null && 
        resource.data.ownerId == request.auth.uid;
      
      // Messages subcollection - party members can read/write
      match /messages/{messageId} {
        allow read: if request.auth != null && 
          (get(/databases/$(database)/documents/parties/$(partyId)).data.ownerId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/parties/$(partyId)).data.memberIds);
        
        allow create: if request.auth != null && 
          (get(/databases/$(database)/documents/parties/$(partyId)).data.ownerId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/parties/$(partyId)).data.memberIds) &&
          request.auth.uid == request.resource.data.userId;
        
        allow update, delete: if request.auth != null && 
          resource.data.userId == request.auth.uid;
      }
    }
    
    // Join requests collection for group join feature
    match /joinRequests/{requestId} {
      // Anyone authenticated can read join requests
      allow read: if request.auth != null;
      
      // Anyone authenticated can create a join request
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.requesterId;
      
      // Can update/delete if requester or group owner
      allow update, delete: if request.auth != null && 
        (resource.data.requesterId == request.auth.uid ||
         resource.data.groupOwnerId == request.auth.uid);
    }
    
    // Homebrew - public content readable by all authenticated users
    match /homebrew/{homebrewId} {
      allow read: if request.auth != null && 
        (resource.data.visibility == 'public' ||
         resource.data.authorId == request.auth.uid ||
         (resource.data.visibility == 'group' && 
          exists(/databases/$(database)/documents/parties/$(resource.data.groupId)) &&
          request.auth.uid in get(/databases/$(database)/documents/parties/$(resource.data.groupId)).data.memberIds));
      
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.authorId;
      
      allow update, delete: if request.auth != null &&
        resource.data.authorId == request.auth.uid;
    }
    
    // User profiles - public read, owner write
    match /userProfiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Collections - user's own only
    match /homebrewCollections/{docId} {
      allow read: if request.auth != null &&
        (resource == null || resource.data.userId == request.auth.uid);
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null &&
        resource.data.userId == request.auth.uid;
    }
    
    // Ratings - authenticated users
    match /homebrewRatings/{ratingId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null &&
        resource.data.userId == request.auth.uid;
    }
    
    // Game Sessions - DM and party members can access
    match /gameSessions/{sessionId} {
      allow read: if request.auth != null &&
        (resource.data.ownerId == request.auth.uid ||
         request.auth.uid in get(/databases/$(database)/documents/parties/$(resource.data.partyId)).data.memberIds);
      
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.ownerId;
      
      allow update: if request.auth != null &&
        resource.data.ownerId == request.auth.uid;
      
      allow delete: if request.auth != null &&
        resource.data.ownerId == request.auth.uid;
    }
    
    // Mail collection - only accessible by Cloud Functions (admin SDK)
    // Client apps should never read or write to this collection
    match /mail/{mailId} {
      allow read, write: if false;
    }
  }
}
